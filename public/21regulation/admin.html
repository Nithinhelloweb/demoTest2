<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button, select { margin: 5px; padding: 5px; }
    table { margin-top: 20px; border-collapse: collapse; width: 100%; }
    th, td { padding: 8px; border: 1px solid #131313; text-align: left; }
    .delete-btn { background: red; color: white; border: none; padding: 4px 8px; cursor: pointer; }
  </style>
  <link rel="icon" type="image/png" href="/images/logo.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
      <img src="/images/logo.png" alt="LOGO" class="logo">
      <h1 class="header-text"><b>SRI SHAKTHI INSTITUTE OF ENGINEERING AND TECHNOLOGY</b></h1>
      <img src="/images/Naac logo" alt="Naac" class="logo">
  </header><br>
  <h2 id="cal">ADMIN PANEL</h2>
  <h3>Add New Subject</h3>

  <input type="text" id="subjectLabel" placeholder="Subject Name">
  <input type="number" id="subjectCredit" placeholder="Credit Point">

  <select id="subjectSemester">
    <option value="">-- Select Semester --</option>
    <option value="Sem-1">Sem-1</option>
    <option value="Sem-2">Sem-2</option>
    <option value="Sem-3">Sem-3</option>
    <option value="Sem-4">Sem-4</option>
    <option value="Sem-5">Sem-5</option>
    <option value="Sem-6">Sem-6</option>
    <option value="Sem-7">Sem-7</option>
    <option value="Sem-8">Sem-8</option>
  </select>

  <select id="subjectDepartment">
    <option value="">-- Select Department --</option>
      <option value="CSE">CSE</option>
      <option value="AIDS">AIDS</option>
      <option value="AIML">AIML</option>
      <option value="ECE">ECE</option>
      <option value="EEE">EEE</option>
      <option value="IT">IT</option>
      <option value="CYBER">CYBER</option>
      <option value="VLSI">VLSI</option>
      <option value="FT">FT</option>
      <option value="BT">BT</option>
      <option value="MECH">MECH</option>
      <option value="AGRI">AGRI</option>
      <option value="CIVIL">CIVIL</option>
  </select>

  <select id="subjectBatch">
    <option value="">-- Select Batch --</option>
    <option value="2022-2026">2022–2026</option>
    <option value="2023-2027">2023–2027</option>
    <option value="2024-2028">2024–2028</option>
  </select>

  <br><br>
  <button onclick="addSubject()">Add Subject</button>

  <h3>Subject List (Filter)</h3>

  <div>
    <label>Semester:</label>
    <select id="filterSemester" onchange="loadSubjectsByBatch()">
      <option value="">-- All --</option>
      <option value="Sem-1">Sem-1</option>
      <option value="Sem-2">Sem-2</option>
      <option value="Sem-3">Sem-3</option>
      <option value="Sem-4">Sem-4</option>
      <option value="Sem-5">Sem-5</option>
      <option value="Sem-6">Sem-6</option>
      <option value="Sem-7">Sem-7</option>
      <option value="Sem-8">Sem-8</option>
    </select>

    <label>Department:</label>
    <select id="filterDepartment" onchange="loadSubjectsByBatch()">
      <option value="">-- All --</option>
      <option value="CSE">CSE</option>
      <option value="AIDS">AIDS</option>
      <option value="AIML">AIML</option>
      <option value="ECE">ECE</option>
      <option value="EEE">EEE</option>
      <option value="IT">IT</option>
      <option value="CYBER">CYBER</option>
      <option value="VLSI">VLSI</option>
      <option value="FT">FT</option>
      <option value="BT">BT</option>
      <option value="MECH">MECH</option>
      <option value="AGRI">AGRI</option>
      <option value="CIVIL">CIVIL</option>
    </select>

    <label>Batch:</label>
    <select id="filterBatch" onchange="loadSubjectsByBatch()">
      <option value="">-- All --</option>
      <option value="2022-2026">2022–2026</option>
      <option value="2023-2027">2023–2027</option>
      <option value="2024-2028">2024–2028</option>
    </select>
  </div>

  <table id="subjectTable">
    <thead>
      <tr>
        <th>Subject</th>
        <th>Credit</th>
        <th>Semester</th>
        <th>Department</th>
        <th>Batch</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="subjectList"></tbody>
  </table>

  <script>
    async function loadSubjectsByBatch() {
      const semester = document.getElementById("filterSemester").value;
      const department = document.getElementById("filterDepartment").value;
      const batch = document.getElementById("filterBatch").value;

      let url = '/api/subjects';
      const params = [];
      if (semester) params.push(`semester=${semester}`);
      if (department) params.push(`department=${department}`);
      if (batch) params.push(`batch=${batch}`);
      if (params.length) url += '?' + params.join('&');

      try {
        const res = await fetch(url);
        const subjects = await res.json();

        const tableBody = document.getElementById("subjectList");
        tableBody.innerHTML = ""; // Clear before re-rendering

        subjects.forEach(subject => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${subject.label}</td>
            <td>${subject.credit}</td>
            <td>${subject.semester}</td>
            <td>${subject.department}</td>
            <td>${subject.batch || '-'}</td>
            <td><button class="delete-btn" onclick="deleteSubject('${subject._id}')">Delete</button></td>
          `;
          tableBody.appendChild(row);
        });
      } catch (err) {
        alert("Failed to load subjects.");
        console.error(err);
      }
    }

    async function addSubject() {
      const label = document.getElementById("subjectLabel").value.trim();
      const credit = parseInt(document.getElementById("subjectCredit").value);
      const semester = document.getElementById("subjectSemester").value;
      const department = document.getElementById("subjectDepartment").value;
      const batch = document.getElementById("subjectBatch").value;

      if (!label || isNaN(credit) || !semester || !department || !batch) {
        alert("Please fill all subject details including batch.");
        return;
      }

      try {
        const res = await fetch('/api/subjects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, credit, semester, department, batch })
        });

        const data = await res.json();
        alert(data.message);

        // Reset inputs
        document.getElementById("subjectLabel").value = "";
        document.getElementById("subjectCredit").value = "";
        document.getElementById("subjectSemester").value = "";
        document.getElementById("subjectDepartment").value = "";
        document.getElementById("subjectBatch").value = "";

        loadSubjectsByBatch();
      } catch (err) {
        alert("Failed to add subject.");
        console.error(err);
      }
    }

    async function deleteSubject(id) {
      if (!confirm("Are you sure you want to delete this subject?")) return;

      try {
        const res = await fetch(`/api/subjects/${id}`, {
          method: 'DELETE'
        });

        const data = await res.json();
        alert(data.message);
        loadSubjectsByBatch();
      } catch (err) {
        alert("Failed to delete subject.");
        console.error(err);
      }
    }

    window.onload = loadSubjectsByBatch;
  </script>
</body>
</html>
